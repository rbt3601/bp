name: CD - Deploy to QA Environment

on:
  workflow_run:
    workflows: ["CI - Build, Tests, Coverage, SonarCloud"]
    types:
      - completed

permissions:
  actions: read
  contents: read

jobs:
  deploy-to-qa:
    runs-on: ubuntu-latest

    # Run only when:
    # 1. CI succeeded
    # 2. CI was triggered by a push event
    # 3. That push was to the QA branch
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      endsWith(github.event.workflow_run.head_branch, 'QA')

    environment:
      name: QA
      url: https://bp-calculator-qa.azurewebsites.net

    steps:
      # Step 1: Download CI artifact
      - name: Download Published Artifact
        uses: actions/download-artifact@v4
        with:
          name: published-app
          path: ./publish

      # Step 2: Deploy to Azure App Service
      - name: Deploy to Azure Web App (QA)
        uses: azure/webapps-deploy@v3
        with:
          app-name: bp-calculator-qa
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_QA }}
          package: ./publish

      # Step 3: Basic E2E check
      - name: Run QA Smoke Test
        run: |
          echo "Checking if the app is running..."
          curl -I https://bp-calculator-qa.azurewebsites.net

      # Step 4: Verify deployment status
      - name: Verify Deployment Success
        run: |
          STATUS=$(curl -I -s https://bp-calculator-qa.azurewebsites.net | head -n 1)
          echo "App Response = $STATUS"
