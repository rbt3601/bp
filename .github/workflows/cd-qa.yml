name: CI-CD Container Pipeline

on:
  push:
    branches:
      - QA   # Only trigger CI/CD when pushing to QA branch

permissions:
  actions: write
  contents: read

env:
  DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  IMAGE_NAME: "bp-calculator"   # Docker image name
  FULL_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/bp-calculator:latest
  AZURE_APP: "bp-calculator-qa" # Azure app service name

jobs:

  #######################################################
  #                     CI JOB
  #######################################################
  ci:
    name: CI - Build, Test, Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install Tools
        run: |
          dotnet tool install --global coverlet.console
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Restore Dependencies
        run: dotnet restore

      # Run Unit Tests + BDD Tests
      - name: Run Tests
        run: |
          mkdir -p TestReports
          dotnet test BPCalculator.Tests/BPCalculator.Tests.csproj \
            --logger "trx;LogFileName=test_results.trx" \
            --results-directory TestReports

      # Run Code Coverage
      - name: Coverage Report
        run: |
          coverlet \
            BPCalculator.Tests/bin/Release/net9.0/BPCalculator.Tests.dll \
            --target "dotnet" \
            --targetargs "test BPCalculator.Tests/BPCalculator.Tests.csproj --no-build" \
            --format opencover \
            --output TestReports/coverage.xml

      # Upload Test Results
      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestReports/

      # Build App (for container)
      - name: Build App
        run: dotnet build --configuration Release

  #######################################################
  #              Build & Push Docker Image
  #######################################################
  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_TOKEN }}

      - name: Build Docker Image
        run: |
          docker build -t $DOCKER_USER/${{ env.IMAGE_NAME }}:latest .

      - name: Push to Docker Hub
        run: docker push $DOCKER_USER/${{ env.IMAGE_NAME }}:latest

  #######################################################
  #                     CD JOB
  #######################################################
  deploy:
    name: Deploy to Azure App Service (Container)
    runs-on: ubuntu-latest
    needs: docker    # Run ONLY after Docker job finishes

    steps:
      - name: Deploy to Azure Web App (Container)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_QA }}
          images: "${{ env.FULL_IMAGE }}"

      - name: Smoke Test After Deployment
        run: |
          URL="https://${{ env.AZURE_APP }}.azurewebsites.net"
          echo "Testing $URL ..."
          
          for i in {1..15}; do
            if curl -s -I $URL | grep "200 OK"; then
              echo "App UP!"
              exit 0
            fi
            echo "Not ready, retrying..."
            sleep 10
          done

          echo "App failed to start!"
          exit 1
