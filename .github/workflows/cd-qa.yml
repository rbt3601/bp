name: QA Pipeline (CI + CD)

on:
  push:
    branches:
      - QA

permissions:
  actions: read
  contents: read

jobs:

  ###############################################################
  #                      CI JOB                                 #
  ###############################################################
  ci:
    name: Build, Test, Quality Scan
    runs-on: ubuntu-latest

    steps:
      # Checkout source code
      - name: Checkout
        uses: actions/checkout@v4

      # Install .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # Install global tools
      - name: Install Tools
        run: |
          dotnet tool install --global dotnet-sonarscanner
          dotnet tool install --global coverlet.console
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      # Restore dependencies
      - name: Restore
        run: dotnet restore

      # Start SonarCloud analysis
      - name: SonarCloud Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
        run: |
          dotnet-sonarscanner begin \
            /k:"${SONAR_PROJECT_KEY}" \
            /o:"${SONAR_ORG}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.token="${SONAR_TOKEN}" \
            /d:sonar.cs.opencover.reportsPaths="TestReports/coverage.opencover.xml"

      # Run security scan
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install trivy -y

      - name: Run Vulnerability Scan
        run: trivy fs --severity HIGH,CRITICAL --exit-code 1 --no-progress .

      # Build app
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # Run Unit Tests + BDD Tests
      - name: Run Unit + BDD Tests
        run: |
          mkdir -p TestReports
          dotnet test BPCalculator.Tests/BPCalculator.Tests.csproj \
            --configuration Release \
            --logger "trx;LogFileName=test_results.trx" \
            --results-directory TestReports

      # Code Coverage
      - name: Generate OpenCover Coverage
        run: |
          mkdir -p TestReports
          coverlet \
            BPCalculator.Tests/bin/Release/net9.0/BPCalculator.Tests.dll \
            --target "dotnet" \
            --targetargs "test BPCalculator.Tests/BPCalculator.Tests.csproj --configuration Release --no-build" \
            --format opencover \
            --output TestReports/coverage.opencover.xml

      # End SonarCloud scan
      - name: SonarCloud End
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet-sonarscanner end /d:sonar.token="${SONAR_TOKEN}"

      # Publish only the web app (IMPORTANT FIX)
      - name: Publish Web App
        run: dotnet publish BPCalculator/BPCalculator.csproj --configuration Release --output ./published-app


      # Upload app for CD
      - name: Upload Published Artifact
        uses: actions/upload-artifact@v4
        with:
          name: published-app
          path: published-app/


  ###############################################################
  #                          CD JOB                               #
  ###############################################################
  cd:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: ci   # must wait until CI completes

    steps:
      # Download the published output from CI
      - name: Download Published App
        uses: actions/download-artifact@v4
        with:
          name: published-app
          path: ./publish

      - name: List Downloaded Files (CD)
        run: |
            echo "Downloaded Artifact Contents:"
            ls -R ./publish


      # Deploy to Azure App Service
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: bp-calculator-qa
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_QA }}
          package: ./publish

      # Smoke test with retry (avoids warm-up failure)
      - name: Smoke Test with Retry
        run: |
            URL="https://bp-calculator-qa-cbgkg0bfdrdbf4c8.norwayeast-01.azurewebsites.net"
            echo "Testing: $URL"

            for i in {1..10}; do
            echo "Attempt $i..."
            curl -I $URL && break
            echo "App not ready yet â€” retrying in 10 seconds..."
            sleep 10
            done


      - name: Final Verification
        run: |
            URL="https://bp-calculator-qa-cbgkg0bfdrdbf4c8.norwayeast-01.azurewebsites.net"
            STATUS=$(curl -I -s $URL | head -n 1)
            echo "App Response = $STATUS"
